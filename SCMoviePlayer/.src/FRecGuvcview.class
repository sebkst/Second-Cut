' Gambas class file

Inherits FMoviePlayer

Public Sub _new()
  Dim m As String
  Shell "which guvcview" To m
  If Len(m) <= 7 Then Message.Error("Error : GuvcView was not found.\nPlease install GuvcView to use this software.\nsudo apt-get install guvcview", "Exit")
  If Len(m) <= 7 Then Quit 
  Me.enableBtnRec(True)
  Return
  
  ' For Each m In args
  '   Print m
  ' Next
  ' Print "----------"
  ' For Each m In Application.Env
  '   Print m & " ";
  '   Print Application.Env[m]    
  ' Next
  
End 

Public Sub btnRec_Click()
  
  'Message.Info("Hello", "OK")
  If Me.existingPlayer Then Me.StopMovie()
  If Me.isrecording Then
       Me.StopRecording()
  Else
'    If InStr(Application.Env["_"], "bin/gambas3") > 0 Then Me.recfile = "/dev/shm/" & Format(Now, "yyyy-mmm-dd_hh-nn-ss") & ".mp4"
'    If InStr(Application.Env["_"], "bin/gambas3") <= 0 Then 
    
    If Exist(User.Home & "/desktop") Then
      Me.recfile = User.Home & "/desktop/" & Format(Now, "yyyy-mmm-dd_hh-nn-ss") & ".mp4"
    Else
      Me.recfile = User.Home & "/" & Format(Now, "yyyy-mmm-dd_hh-nn-ss") & ".mp4"
      If Exist(User.Home & "/video") Then Me.recfile = User.Home & "/video/" & Format(Now, "yyyy-mmm-dd_hh-nn-ss") & ".mp4" 
    Endif
    Print "start recording into " & Me.recfile
    If Len(Me.getcbVideoDeviceText()) > 0 Then
      Me.videodevice = Me.getcbVideoDeviceText()
    Endif
    startRecording(Me.recfile)
  Endif
End


Public Sub startRecording(mp4 As String)
  Dim r As String
  If Len(mp4) <= 0 Then Return
  Me.oldme = [Me.ScreenX, Me.ScreenY, Me.W, Me.H]

  Me.hideDwgMoviePlayer()
  Me.Move(0, Screen.AvailableHeight - 50, Screen.AvailableWidth, 50)
  Me.$bShow = True
  Me.Stacking = Window.Above
  
  'playps = Exec ["mplayer", "-wid", CStr(dwgMoviePlayer.Handle), "-speed", CStr(speed), Conv$(mp4, Desktop.Charset, System.Charset)] For Read Write As "Process"
  '
  r = "guvcview -p 1 --device=" & Me.videodevice & " --size=" & CStr(Me.dimRecVideo[0]) & "x" & CStr(Me.dimRecVideo[1])
  r = r & " --video=" & Conv$(mp4, Desktop.Charset, System.Charset) ' & " --exit_on_close"
  Print r 
'  Me.recps = Shell r For Read Write As "RecProcess"
  Me.recps = Exec Split(r, " ") For Read Write As "RecProcess"
  'dwgMoviePlayer.Hide
  'timShow.Enabled = True
  Me.setTxtcmdText("")
  Me.isrecording = True 
  
End


Public Sub recProcess_Kill()
  Print "Stop Recording******************************"
  Me.isrecording = False   
End
Private Last_recProcess_Read As String = ""
Public Sub recProcess_Read()
    Dim sData As String  
    Read #Last, sData, Lof(Last)
    'sData = Read #Last, -255
    If Not (Last_recProcess_Read == sData) Then
      Print "recps: " & sData
       Last_recProcess_Read = sData
    Else 
      Print ","; 
    Endif
End

